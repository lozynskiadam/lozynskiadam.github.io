var xe=Object.defineProperty;var ke=(n,e,t)=>e in n?xe(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var d=(n,e,t)=>(ke(n,typeof e!="symbol"?e+"":e,t),t),fe=(n,e,t)=>{if(!e.has(n))throw TypeError("Cannot "+t)};var c=(n,e,t)=>(fe(n,e,"read from private field"),t?t.call(n):e.get(n)),g=(n,e,t)=>{if(e.has(n))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(n):e.set(n,t)},y=(n,e,t,s)=>(fe(n,e,"write to private field"),s?s.call(n,t):e.set(n,t),t);var ie=(n,e,t,s)=>({set _(i){y(n,e,i,t)},get _(){return c(n,e,s)}});(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const u of o.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&s(u)}).observe(document,{childList:!0,subtree:!0});function t(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function s(i){if(i.ep)return;i.ep=!0;const o=t(i);fetch(i.href,o)}})();const f=32,de=33,me=19,Se="data/sprites.json",Pe="data/items.json",Ke="data/effects.json";const Ee=function(n){return Math.floor(Math.random()*(n+1))},N=function(n){return Ee(n)===n},Ae=function(n){return window.btoa(String.fromCharCode(...window.crypto.getRandomValues(new Uint8Array(n*2)))).replace(/[+/]/g,"").substring(0,n)},ne=function(){return"#000000".replace(/0/g,function(){return(~~(Math.random()*16)).toString(16)})},ye=function(n){const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(n);return e?[parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16)]:null},Ie=function(n,e){Object.keys(e).forEach(i=>{e[ye(i).toString()]=ye(e[i]),delete e[i]});const t=document.createElement("canvas").getContext("2d");t.canvas.width=n.width,t.canvas.height=n.height,t.drawImage(n,0,0);const s=t.getImageData(0,0,t.canvas.width,t.canvas.height);for(let i=0;i<s.data.length;i+=4){const o=[s.data[i],s.data[i+1],s.data[i+2]].toString();if(o in e){const u=e[o];s.data[i]=u[0],s.data[i+1]=u[1],s.data[i+2]=u[2],s.data[i+3]=255}}return t.putImageData(s,0,0),t.canvas},pe=async function(n){return new Promise(e=>{const t=new Image;t.onload=()=>e(t),t.src=n})},Te=async function(n,e,t){return new Promise(s=>{if(!e)return n;const i=["#ff0000","#ff00ff","#0000ff","#ffff00","#00ffff","#ff00ff"],o={};t.forEach((b,p)=>{o[i[p]]=b});const u=Ie(e,o),v=document.createElement("canvas").getContext("2d");v.canvas.width=n.width,v.canvas.height=n.height,v.drawImage(n,0,0),v.globalCompositeOperation="overlay",v.drawImage(u,0,0);const C=new Image;C.onload=()=>s(C),C.src=v.canvas.toDataURL("image/png")})};var J,re,O,X,Y,I,K,k,G,q,B,T,V;const W=class W{constructor(e,t){g(this,re,null);g(this,O,null);g(this,X,null);g(this,Y,null);g(this,I,null);g(this,K,null);g(this,k,null);g(this,G,null);g(this,q,null);g(this,B,null);g(this,T,null);g(this,V,null);e&&(c(W,J)[e]=this),y(this,re,e),y(this,O,t.image),y(this,X,t.image),y(this,Y,t.mask||null),y(this,I,t.speed||null),y(this,K,t.states||{}),c(this,K).origin=[{x:0,y:0,w:c(this,O).width,h:c(this,O).height}],y(this,k,document.createElement("canvas")),y(this,G,c(this,k).getContext("2d")),y(this,B,this.getDefaultState()),y(this,T,1)}static async load(e){try{const s=await(await fetch(e)).json();await Promise.all(Object.entries(s).map(async([i,o])=>{const v={image:await pe(o.base),speed:o.speed||null,states:o.states||null};o.mask&&(v.mask=await pe(o.mask)),new W(i,v)}))}catch(t){console.error("Error loading sprites:",t)}}static get(e){return c(W,J)[e]??null}clone(){return new W(null,{image:c(this,X),mask:c(this,Y),speed:c(this,I),states:c(this,K)})}async play(e=null){return new Promise(t=>{e=e||this.getDefaultState(),this.stop(),this.rewind(),y(this,B,e);const s=c(this,K)[e].length;s>1&&c(this,I)&&y(this,q,setInterval(()=>{++ie(this,T)._>s&&(this.stop(),t())},c(this,I)))})}stop(){clearInterval(c(this,q)),y(this,q,null)}rewind(){y(this,T,1)}loop(e=null){if(e=e||this.getDefaultState(),c(this,q)&&c(this,B)===e)return;this.stop(),this.rewind(),y(this,B,e);const t=c(this,K)[e].length;t>1&&c(this,I)&&y(this,q,setInterval(()=>{++ie(this,T)._>t&&y(this,T,1)},c(this,I)))}async dye(e){y(this,O,await Te(c(this,X),c(this,Y),e)),y(this,V,null)}getDefaultState(){return Object.keys(c(this,K))[0]}getFrame(){const e=c(this,K)[c(this,B)][c(this,T)-1];return c(this,V)===e?c(this,k):(y(this,V,e),c(this,k).width=e.w,c(this,k).height=e.h,c(this,G).clearRect(0,0,c(this,k).width,c(this,k).height),c(this,G).drawImage(c(this,O),e.x,e.y,e.w,e.h,0,0,e.w,e.h),c(this,k))}};J=new WeakMap,re=new WeakMap,O=new WeakMap,X=new WeakMap,Y=new WeakMap,I=new WeakMap,K=new WeakMap,k=new WeakMap,G=new WeakMap,q=new WeakMap,B=new WeakMap,T=new WeakMap,V=new WeakMap,g(W,J,{});let D=W;var ee;const H=class H{constructor(e,t){d(this,"id",null);d(this,"name",null);d(this,"sprite",null);d(this,"type",null);d(this,"isBlockingCreatures",null);d(this,"isMoveable",null);c(H,ee)[e]=this,this.id=t.id,this.name=t.name,this.sprite=D.get(t.sprite),this.sprite.loop(),this.type=t.type,this.isBlockingCreatures=t.isBlockingCreatures,this.isMoveable=t.isMoveable}static async load(e){try{const s=await(await fetch(e)).json();return new Promise(i=>{Object.values(s).forEach(o=>{new H(o.id,o)}),i()})}catch(t){console.error("Error loading items:",t)}}static get(e){return c(H,ee)[e]??null}};ee=new WeakMap,g(H,ee,{});let P=H;class j{static init(){window.addEventListener("move-north",()=>m.walk("north")),window.addEventListener("move-south",()=>m.walk("south")),window.addEventListener("move-west",()=>m.walk("west")),window.addEventListener("move-east",()=>m.walk("east"))}static move(e,t,s){e.movement.timeouts.forEach(i=>clearTimeout(i)),e.movement.timeouts=[],e.currentFrame=0,e.offset={x:0,y:0},e.movement.isMoving=!0;for(let i=0;i<f;i++){const o=setTimeout(()=>j.handleMovingFrame(e,t,s),1e3/e.speed/f*i);e.movement.timeouts.push(o)}}static handleMovingFrame(e,t,s){if(e.sprite.loop("walk-"+s),e.movement.currentFrame++,j.updateOffsetAfterAnimationFrameChange(e,s),e.movement.currentFrame===f/2&&(e.position=t,window.dispatchEvent(new CustomEvent("hero-position-changed")),j.updateOffsetAfterPositionChange(e,s)),e.movement.currentFrame===f){if(e.movement.isMoving=!1,e.movement.currentFrame=0,e.movement.timeouts.forEach(i=>clearTimeout(i)),e.movement.timeouts=[],e.isHero()&&m.queuedMove&&(s=m.queuedMove,m.queuedMove=null,m.walk(s)))return;e.sprite.loop("idle-"+s)}}static getTargetPosition(e,t){const s={north:{x:0,y:-1},south:{x:0,y:1},west:{x:-1,y:0},east:{x:1,y:0}};return{x:e.position.x+s[t].x,y:e.position.y+s[t].y}}static updateOffsetAfterAnimationFrameChange(e,t){({north:()=>e.offset.y--,south:()=>e.offset.y++,west:()=>e.offset.x--,east:()=>e.offset.x++})[t]()}static updateOffsetAfterPositionChange(e,t){({north:()=>e.offset.y=f/2,south:()=>e.offset.y=-(f/2),west:()=>e.offset.x=f/2,east:()=>e.offset.x=-(f/2)})[t]()}}class ge{constructor(e,t,s){d(this,"position",{x:null,y:null});d(this,"offset",{x:null,y:null});d(this,"sprite",null);d(this,"speed",2);d(this,"movement",{isMoving:!1,currentFrame:0,timeouts:[]});l.creatures[e]=this,this.position=t,this.offset=s,this.sprite=D.get("outfit").clone(),this.sprite.dye([ne(),ne(),ne(),ne()]),this.sprite.loop("idle-south")}isHero(){return this===m.creature}move(e,t){j.move(this,t,e)}}const x=class x{static init(){x.creature=new ge("Nemnes",{x:100,y:100},{x:0,y:0}),Q.get("energy").run(x.creature.position)}static walk(e){if(x.creature.movement.isMoving)return x.creature.movement.currentFrame>f-f/3?(x.queuedMove=e,!0):!1;const t=j.getTargetPosition(x.creature,e);return l.isWalkable(t)?(j.move(this.creature,t,e),!0):(x.creature.sprite.loop("idle-"+e),!1)}};d(x,"creature",null),d(x,"queuedMove",null);let m=x;const ve=function(n,e,t=1){const s=n.x-t,i=n.y-t,o=n.x+t,u=n.y+t;return e.x>=s&&e.x<=o&&e.y>=i&&e.y<=u},U=function(n,e){return n.x===e.x&&n.y===e.y},a=class a{static init(){const e=document.createElement("canvas");e.id="board",e.width=f*de,e.height=f*me,document.querySelector("#app").append(e),a.ctx=e.getContext("2d"),a.width=de,a.height=me,a.update(),window.addEventListener("hero-position-changed",()=>{a.update()})}static update(){a.area.fromX=m.creature.position.x-Math.floor(a.width/2),a.area.toX=m.creature.position.x+Math.floor(a.width/2),a.area.fromY=m.creature.position.y-Math.floor(a.height/2),a.area.toY=m.creature.position.y+Math.floor(a.height/2);for(const[s,i]of Object.entries(a.creatures))a.isOnArea(i.position)||delete a.creatures[s];const e=[],t={};for(let s=a.area.fromY;s<=a.area.toY;s++)for(let i=a.area.fromX;i<=a.area.toX;i++)t[s]=t[s]||{},a.tiles[s]&&a.tiles[s][i]?t[s][i]=a.tiles[s][i]:(t[s][i]=[],e.push({x:i,y:s}));a.tiles=t,a.requestTiles(e)}static getTileStack(e){return typeof a.tiles[e.y]>"u"||typeof a.tiles[e.y][e.x]>"u"?[]:a.tiles[e.y][e.x]}static getTileTopItem(e){const t=a.getTileStack(e);return t[t.length-1]??null}static updateTile(e,t){typeof a.tiles[e.y]<"u"&&typeof a.tiles[e.y][e.x]<"u"&&(a.tiles[e.y][e.x]=t)}static requestTiles(e){setTimeout(()=>{for(const t of e){const s=[];N(40)?s.push(2):N(40)?s.push(3):N(30)?s.push(4):s.push(1),U(t,m.creature.position)||(N(100)?s.push(6):N(100)&&s.push(8)),a.updateTile(t,s),N(350)&&new ge(Ae(20),t,{x:0,y:0})}},100)}static isWalkable(e){const t=a.getTileStack(e);return!(!t.find(s=>P.get(s).type==="ground")||t.find(s=>P.get(s).isBlockingCreatures))}static isOnArea(e){return e.x>=a.area.fromX&&e.x<=a.area.toX&&e.y>=a.area.fromY&&e.y<=a.area.toY}static positionLocalToServer(e){return{x:a.area.fromX+e.x,y:a.area.fromY+e.y}}static getVisibleEffectsSprites(e){return a.effects&&a.effects[e.y]&&a.effects[e.y][e.x]?Object.values(this.effects[e.y][e.x]):[]}};d(a,"ctx",null),d(a,"width",null),d(a,"height",null),d(a,"tiles",{}),d(a,"effects",{}),d(a,"creatures",{}),d(a,"area",{fromX:null,fromY:null,toX:null,toY:null});let l=a;var te,ae,le,se;const L=class L{constructor(e,t){g(this,le,null);g(this,se,null);c(L,te)[e]=this,y(this,le,e),y(this,se,t)}static async load(e){try{const s=await(await fetch(e)).json();return new Promise(i=>{Object.values(s).forEach(o=>{new L(o.id,D.get(o.sprite))}),i()})}catch(t){console.error("Error loading effects:",t)}}static get(e){return c(L,te)[e]??null}run(e){l.effects[e.y]||(l.effects[e.y]={}),l.effects[e.y][e.x]||(l.effects[e.y][e.x]={});const t=++ie(L,ae)._,s=c(this,se).clone();l.effects[e.y][e.x][t]=s,s.play().then(()=>{delete l.effects[e.y][e.x][t]})}};te=new WeakMap,ae=new WeakMap,le=new WeakMap,se=new WeakMap,g(L,te,{}),g(L,ae,0);let Q=L;var Re=Object.defineProperty,Le=(n,e,t)=>e in n?Re(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,h=(n,e,t)=>(Le(n,typeof e!="symbol"?e+"":e,t),t);class we{constructor(e){h(this,"_onPressed"),h(this,"_onPressedWithRepeat"),h(this,"_onReleased"),h(this,"_isPressed"),h(this,"_identity"),this._isPressed=!1,this._identity=e,typeof e=="function"?this._onPressedWithRepeat=e:(this._onPressed=e.onPressed,this._onPressedWithRepeat=e.onPressedWithRepeat,this._onReleased=e.onReleased)}get isEmpty(){return!this._onPressed&&!this._onPressedWithRepeat&&!this._onReleased}isOwnHandler(e){return this._identity===e}executePressed(e){var t,s;this._isPressed||(t=this._onPressed)==null||t.call(this,e),this._isPressed=!0,(s=this._onPressedWithRepeat)==null||s.call(this,e)}executeReleased(e){var t;this._isPressed&&((t=this._onReleased)==null||t.call(this,e)),this._isPressed=!1}}const ce=class A{constructor(e,t,s={}){h(this,"_normalizedKeyCombo"),h(this,"_parsedKeyCombo"),h(this,"_handlerState"),h(this,"_keyComboEventMapper"),h(this,"_movingToNextSequenceAt"),h(this,"_sequenceIndex"),h(this,"_unitIndex"),h(this,"_lastActiveKeyPresses"),h(this,"_lastActiveKeyCount"),h(this,"_isPressedWithFinalUnit"),this._normalizedKeyCombo=A.normalizeKeyCombo(e),this._parsedKeyCombo=A.parseKeyCombo(e),this._handlerState=new we(s),this._keyComboEventMapper=t,this._movingToNextSequenceAt=0,this._sequenceIndex=0,this._unitIndex=0,this._lastActiveKeyPresses=[],this._lastActiveKeyCount=0,this._isPressedWithFinalUnit=null}static parseKeyCombo(e){if(A._parseCache[e])return A._parseCache[e];const t=e.toLowerCase();let s="",i=[],o=[i],u=[o];const v=[u];let C=!1;for(let p=0;p<e.length;p+=1)if(t[p]==="\\")C=!0;else if((t[p]==="+"||t[p]===">"||t[p]===",")&&!C){if(s)throw new Error("cannot have two operators in a row");s=t[p]}else t[p].match(/[^\s]/)&&(s&&(s===","?(i=[],o=[i],u=[o],v.push(u)):s===">"?(i=[],o=[i],u.push(o)):s==="+"&&(i=[],o.push(i)),s=""),C=!1,i.push(t[p]));const b=v.map(p=>p.map(Z=>Z.map(_=>_.join(""))));return A._parseCache[e]=b,b}static stringifyKeyCombo(e){return e.map(t=>t.map(s=>s.map(i=>i==="+"?"\\+":i===">"?"\\>":i===","?"\\,":i).join("+")).join(">")).join(",")}static normalizeKeyCombo(e){if(A._normalizationCache[e])return A._normalizationCache[e];const t=this.stringifyKeyCombo(this.parseKeyCombo(e));return A._normalizationCache[e]=t,t}get isPressed(){return!!this._isPressedWithFinalUnit}get sequenceIndex(){return this.isPressed?this._parsedKeyCombo.length:this._sequenceIndex}isOwnHandler(e){return this._handlerState.isOwnHandler(e)}executePressed(e){var t;(t=this._isPressedWithFinalUnit)!=null&&t.has(e.key)&&this._handlerState.executePressed(this._wrapEvent(this._lastActiveKeyPresses,{key:e.key,event:e}))}executeReleased(e){var t;(t=this._isPressedWithFinalUnit)!=null&&t.has(e.key)&&(this._handlerState.executeReleased(this._wrapEvent(this._lastActiveKeyPresses,{key:e.key,event:e})),this._isPressedWithFinalUnit=null)}updateState(e,t){const s=e.length,i=s<this._lastActiveKeyCount;this._lastActiveKeyCount=s;const o=this._parsedKeyCombo[this._sequenceIndex],u=o.slice(0,this._unitIndex),v=o.slice(this._unitIndex),C=()=>{this._movingToNextSequenceAt=0,this._sequenceIndex=0,this._unitIndex=0,this._lastActiveKeyPresses.length=0,this._handlerState.isEmpty&&(this._isPressedWithFinalUnit=null)};let b=0;if(i){if(this._movingToNextSequenceAt===0)return C();if(this._movingToNextSequenceAt+t<Date.now()||s!==0)return;this._movingToNextSequenceAt=0,this._sequenceIndex+=1,this._unitIndex=0;return}for(const p of u){for(const Z of p){let _=!1;for(let E=b;E<e.length&&E<b+p.length;E+=1)if(e[E].key===Z){_=!0;break}if(!_)return C()}b+=p.length}if(this._movingToNextSequenceAt===0){for(const p of v){for(const Z of p){let _=!1;for(let E=b;E<e.length&&E<b+p.length;E+=1)if(e[E].key===Z){_=!0;break}if(!_)return}this._unitIndex+=1,b+=p.length}if(b<s-1)return C();if(this._lastActiveKeyPresses[this._sequenceIndex]=e.slice(0),this._sequenceIndex<this._parsedKeyCombo.length-1){this._movingToNextSequenceAt=Date.now();return}this._isPressedWithFinalUnit=new Set(o[o.length-1])}}_wrapEvent(e,t){return{...this._keyComboEventMapper(e,t),keyCombo:this._normalizedKeyCombo,keyEvents:e.flat().map(s=>s.event),finalKeyEvent:t.event}}};h(ce,"_parseCache",{}),h(ce,"_normalizationCache",{});let M=ce;const Fe={addEventListener:(...n)=>{},removeEventListener:(...n)=>{},dispatchEvent:(...n)=>{}},Me={userAgent:""},$=()=>typeof document<"u"?document:Fe,Oe=()=>typeof navigator<"u"?navigator:Me,qe=()=>Oe().userAgent.toLocaleLowerCase().includes("mac");let he=!1;const Be=n=>{!qe()||n.key!=="Meta"||(he=!0)},je=n=>{!he||n.key!=="Meta"||(he=!1,be())},oe=new Map,_e=n=>{oe.set(n.key,n)},We=n=>{oe.delete(n.key)},be=()=>{for(const n of oe.values()){const e=new KeyboardEvent("keyup",{key:n.key,code:n.code,bubbles:!0,cancelable:!0});$().dispatchEvent(e)}oe.clear()},De=n=>{try{const e=()=>n();return addEventListener("focus",e),()=>{removeEventListener("focus",e)}}catch{}},ze=n=>{try{const e=()=>{be(),n()};return addEventListener("blur",e),()=>removeEventListener("blur",e)}catch{}},Ne=n=>{try{const e=t=>(_e(t),Be(t),n({key:t.key,originalEvent:t,composedPath:()=>t.composedPath(),preventDefault:()=>t.preventDefault()}));return $().addEventListener("keydown",e),()=>$().removeEventListener("keydown",e)}catch{}},He=n=>{try{const e=t=>(We(t),je(t),n({key:t.key,originalEvent:t,composedPath:()=>t.composedPath(),preventDefault:()=>t.preventDefault()}));return $().addEventListener("keyup",e),()=>$().removeEventListener("keyup",e)}catch{}},Ue=1e3;class Xe{constructor(e={}){h(this,"sequenceTimeout"),h(this,"_isActive"),h(this,"_unbinder"),h(this,"_onActiveBinder"),h(this,"_onInactiveBinder"),h(this,"_onKeyPressedBinder"),h(this,"_onKeyReleasedBinder"),h(this,"_keyComboEventMapper"),h(this,"_selfReleasingKeys"),h(this,"_keyRemap"),h(this,"_handlerStates"),h(this,"_keyComboStates"),h(this,"_keyComboStatesArray"),h(this,"_activeKeyPresses"),h(this,"_activeKeyMap"),h(this,"_watchedKeyComboStates"),this.sequenceTimeout=Ue,this._isActive=!0,this._onActiveBinder=()=>{},this._onInactiveBinder=()=>{},this._onKeyPressedBinder=()=>{},this._onKeyReleasedBinder=()=>{},this._keyComboEventMapper=()=>({}),this._selfReleasingKeys=[],this._keyRemap={},this._handlerStates={},this._keyComboStates={},this._keyComboStatesArray=[],this._activeKeyPresses=[],this._activeKeyMap=new Map,this._watchedKeyComboStates={},this.bindEnvironment(e)}get pressedKeys(){return this._activeKeyPresses.map(e=>e.key)}bindKey(e,t){var s;e=e.toLowerCase();const i=new we(t);(s=this._handlerStates)[e]??(s[e]=[]),this._handlerStates[e].push(i)}unbindKey(e,t){e=e.toLowerCase();const s=this._handlerStates[e];if(s)if(t)for(let i=0;i<s.length;i+=1)s[i].isOwnHandler(t)&&(s.splice(i,1),i-=1);else s.length=0}bindKeyCombo(e,t){var s;e=M.normalizeKeyCombo(e);const i=new M(e,this._keyComboEventMapper,t);(s=this._keyComboStates)[e]??(s[e]=[]),this._keyComboStates[e].push(i),this._keyComboStatesArray.push(i)}unbindKeyCombo(e,t){e=M.normalizeKeyCombo(e);const s=this._keyComboStates[e];if(s)if(t){for(let i=0;i<s.length;i+=1)if(s[i].isOwnHandler(t)){for(let o=0;o<this._keyComboStatesArray.length;o+=1)this._keyComboStatesArray[o]===s[i]&&(this._keyComboStatesArray.splice(o,1),o-=1);s.splice(i,1),i-=1}}else s.length=0}checkKey(e){return this._activeKeyMap.has(e.toLowerCase())}checkKeyCombo(e){return this._ensureCachedKeyComboState(e).isPressed}checkKeyComboSequenceIndex(e){return this._ensureCachedKeyComboState(e).sequenceIndex}bindEnvironment(e={}){this.unbindEnvironment(),this._onActiveBinder=e.onActive??De,this._onInactiveBinder=e.onInactive??ze,this._onKeyPressedBinder=e.onKeyPressed??Ne,this._onKeyReleasedBinder=e.onKeyReleased??He,this._keyComboEventMapper=e.mapKeyComboEvent??(()=>({})),this._selfReleasingKeys=e.selfReleasingKeys??[],this._keyRemap=e.keyRemap??{};const t=this._onActiveBinder(()=>{this._isActive=!0}),s=this._onInactiveBinder(()=>{this._isActive=!1}),i=this._onKeyPressedBinder(u=>{this._handleKeyPress(u)}),o=this._onKeyReleasedBinder(u=>{this._handleKeyRelease(u)});this._unbinder=()=>{t==null||t(),s==null||s(),i==null||i(),o==null||o()}}unbindEnvironment(){var e;(e=this._unbinder)==null||e.call(this)}_ensureCachedKeyComboState(e){e=M.normalizeKeyCombo(e),this._watchedKeyComboStates[e]||(this._watchedKeyComboStates[e]=new M(e,this._keyComboEventMapper));const t=this._watchedKeyComboStates[e];return t.updateState(this._activeKeyPresses,this.sequenceTimeout),t}_handleKeyPress(e){if(!this._isActive)return;e={...e,key:e.key.toLowerCase()};const t=this._keyRemap[e.key];t&&(e.key=t);const s=this._handlerStates[e.key];if(s)for(const o of s)o.executePressed(e);const i=this._activeKeyMap.get(e.key);if(i)i.event=e;else{const o={key:e.key,event:e};this._activeKeyMap.set(e.key,o),this._activeKeyPresses.push(o)}this._updateKeyComboStates();for(const o of this._keyComboStatesArray)o.executePressed(e)}_handleKeyRelease(e){e={...e,key:e.key.toLowerCase()};const t=this._keyRemap[e.key];t&&(e.key=t);const s=this._handlerStates[e.key];if(s)for(const i of s)i.executeReleased(e);if(this._activeKeyMap.has(e.key)){this._activeKeyMap.delete(e.key);for(let i=0;i<this._activeKeyPresses.length;i+=1)if(this._activeKeyPresses[i].key===e.key){this._activeKeyPresses.splice(i,1),i-=1;break}}this._tryReleaseSelfReleasingKeys(),this._updateKeyComboStates();for(const i of this._keyComboStatesArray)i.executeReleased(e)}_updateKeyComboStates(){for(const e of this._keyComboStatesArray)e.updateState(this._activeKeyPresses,this.sequenceTimeout)}_tryReleaseSelfReleasingKeys(){for(const e of this._activeKeyPresses)for(const t of this._selfReleasingKeys)e.key===t&&this._handleKeyRelease(e.event)}}let Ye,ue;const Ge=n=>{ue=n??new Xe(Ye)},Ce=()=>(ue||Ge(),ue),Ve=(...n)=>Ce().bindKey(...n),R=(...n)=>Ce().checkKey(...n);M.normalizeKeyCombo;M.stringifyKeyCombo;M.parseKeyCombo;const r=class r{static init(){document.addEventListener("mousemove",r.onMove,!1),document.addEventListener("mousedown",e=>{(e.which===1||e.button===0)&&(r.buttons.left.isPressed=!0,r.onLeftButtonClick()),(e.which===3||e.button===2)&&(r.buttons.right.isPressed=!0,r.onRightButtonClick())}),document.addEventListener("mouseup",e=>{(e.which===1||e.button===0)&&(r.buttons.left.isPressed=!1,r.grabbing.itemId&&r.onGrabEnd()),(e.which===3||e.button===2)&&(r.buttons.right.isPressed=!1)}),document.addEventListener("contextmenu",e=>(e==null?void 0:e.cancelable)&&e.preventDefault())}static onMove(e){const t=l.ctx.canvas.getBoundingClientRect(),s={positionWindow:{...r.positionWindow},positionClient:{...r.positionClient},positionServer:{...r.positionServer}};r.positionWindow={x:e.clientX,y:e.clientY},r.positionClient={x:Math.floor(((e.clientX-t.left)/(t.right-t.left)*l.ctx.canvas.width+m.creature.offset.x)/f),y:Math.floor(((e.clientY-t.top)/(t.bottom-t.top)*l.ctx.canvas.height+m.creature.offset.y)/f)},r.positionServer=l.positionLocalToServer(r.positionClient),U(r.positionClient,s.positionClient)||r.onPositionChange(),U(r.positionServer,s.positionServer)||r.onPositionChange()}static onPositionChange(){if(r.grabbing.itemId)return;if(z.shift.isPressed){l.ctx.canvas.setAttribute("cursor","eye");return}r.positionServer=l.positionLocalToServer(r.positionClient);const e=l.getTileTopItem(r.positionServer);if(!e){l.ctx.canvas.removeAttribute("cursor");return}e===6?l.ctx.canvas.setAttribute("cursor","chest"):e===8?l.ctx.canvas.setAttribute("cursor","pick"):l.ctx.canvas.removeAttribute("cursor")}static onLeftButtonClick(){if(z.shift.isPressed)return;const e=l.getTileTopItem(r.positionServer);if(e&&P.get(e).isMoveable){r.onGrabStart(e);return}}static onRightButtonClick(){const e=l.getTileTopItem(r.positionServer);if(!r.buttons.right.isBlocked&&e&&ve(m.creature.position,r.positionServer)){if(e===6){r.buttons.right.isBlocked=!0,Q.get("yellow-sparkles").run(r.positionServer),l.tiles[r.positionServer.y][r.positionServer.x].pop(),l.tiles[r.positionServer.y][r.positionServer.x].push(9),r.onPositionChange(),setTimeout(()=>{r.buttons.right.isBlocked=!1},600);return}if(e===8){r.buttons.right.isBlocked=!0,Q.get("ore-hit").run(r.positionServer),l.tiles[m.creature.position.y][m.creature.position.x].push(10),setTimeout(()=>{r.buttons.right.isBlocked=!1},600);return}}}static onGrabStart(e){r.grabbing.itemId=e,r.grabbing.position={...r.positionServer},l.ctx.canvas.setAttribute("cursor","crosshair")}static onGrabEnd(){r.handleThrow(),r.grabbing.itemId=null,r.grabbing.position={x:null,y:null},r.onPositionChange()}static handleThrow(){if(ve(m.creature.position,r.grabbing.position)===!1||U(r.grabbing.position,r.positionServer))return;const e=l.getTileTopItem(r.grabbing.position);e===r.grabbing.itemId&&(l.getTileStack(r.positionServer).find(t=>P.get(t).isBlockingCreatures)||(l.tiles[r.grabbing.position.y][r.grabbing.position.x].pop(),l.tiles[r.positionServer.y][r.positionServer.x].push(e)))}};d(r,"positionWindow",{x:null,y:null}),d(r,"positionClient",{x:null,y:null}),d(r,"positionServer",{x:null,y:null}),d(r,"buttons",{left:{isBlocked:!1,isPressed:!1},right:{isBlocked:!1,isPressed:!1}}),d(r,"grabbing",{itemId:null,position:{x:null,y:null}});let S=r;const F=class F{static init(){document.addEventListener("keydown",()=>setTimeout(F.triggerKeyHoldingFunctions)),window.keyboardLoop=setInterval(F.triggerKeyHoldingFunctions,200),Ve("shift",{onPressed:()=>{F.shift.isPressed=!0,S.onPositionChange()},onReleased:()=>{F.shift.isPressed=!1,S.onPositionChange()}})}};d(F,"shift",{isPressed:!1}),d(F,"triggerKeyHoldingFunctions",()=>{(R("ArrowUp")||R("w"))&&window.dispatchEvent(new CustomEvent("move-north")),(R("ArrowDown")||R("s"))&&window.dispatchEvent(new CustomEvent("move-south")),(R("ArrowLeft")||R("a"))&&window.dispatchEvent(new CustomEvent("move-west")),(R("ArrowRight")||R("d"))&&window.dispatchEvent(new CustomEvent("move-east"))});let z=F;class w{static renderTile(e,t,s,i){s==="ground"&&i.forEach(o=>{P.get(o).type==="ground"&&w.drawSprite(e,P.get(o).sprite)}),s==="objects"&&(i.forEach(o=>{const u=P.get(o);u.type==="object"&&w.drawSprite(e,u.sprite)}),z.shift.isPressed&&U(e,S.positionClient)&&w.drawSprite(e,D.get("cursor")),Object.values(l.creatures).forEach(o=>{U(t,o.position)&&w.drawCreature(e,o)}),l.getVisibleEffectsSprites(t).forEach(o=>{w.drawSprite(e,o)}))}static drawSprite(e,t){const s=t.getFrame(),i=e.y*f+(f-s.height),o=e.x*f+(Math.ceil(f/2)-Math.ceil(s.width/2));w.tempCtx.drawImage(s,o,i)}static drawCreature(e,t){const s=t.sprite.getFrame(),i=e.y*f+(f-s.height)+t.offset.y,o=e.x*f+(Math.ceil(f/2)-Math.ceil(s.width/2))+t.offset.x;w.tempCtx.drawImage(s,o,i)}static cropEdges(e){e.clearRect(0,0,f,e.canvas.height),e.clearRect(0,0,e.canvas.width,f),e.clearRect(e.canvas.width-f,0,e.canvas.width,e.canvas.height),e.clearRect(0,e.canvas.height-f,e.canvas.width,e.canvas.height)}static render(){const e=document.createElement("canvas");e.width=l.ctx.canvas.width,e.height=l.ctx.canvas.height,w.tempCtx=e.getContext("2d"),w.tempCtx.fillStyle="#25131a",w.tempCtx.fillRect(0,0,w.tempCtx.canvas.width,w.tempCtx.canvas.height);for(let t of["ground","objects"]){let s=0;for(let[i,o]of Object.entries(l.tiles)){let u=0;for(let[v,C]of Object.entries(o)){const b={x:u,y:s},p={x:Number(v),y:Number(i)};w.renderTile(b,p,t,C),u++}s++}}w.renderInfoBox(w.tempCtx),l.ctx.clearRect(0,0,l.ctx.canvas.width,l.ctx.canvas.height),l.ctx.drawImage(e,-m.creature.offset.x,-m.creature.offset.y),w.cropEdges(l.ctx),window.requestAnimationFrame(w.render)}static renderInfoBox(e){if(z.shift.isPressed){const t={x:S.positionClient.x*f+f/3*2,y:S.positionClient.y*f+f/3*2};for(const[o,u]of Object.entries(l.creatures))if(S.positionServer.x===u.position.x&&S.positionServer.y===u.position.y){const v=o.length*5.5+8;e.fillStyle="#1c3d17",e.fillRect(t.x,t.y,v,16),e.strokeStyle="#FFA500",e.strokeRect(t.x,t.y,v,16),e.font="normal bold 9px monospace",e.strokeStyle="#000000",e.strokeText(o,t.x+4,t.y+11),e.strokeText(o,t.x+4,t.y+11),e.fillStyle="#FFA500",e.fillText(o,t.x+4,t.y+11);return}const s=l.getTileTopItem(S.positionServer),i=P.get(s);if(i&&i.type==="object"){const o=i.name.length*5.5+8;e.fillStyle="#172459",e.fillRect(t.x,t.y,o,16),e.strokeStyle="#FFA500",e.strokeRect(t.x,t.y,o,16),e.font="normal bold 9px monospace",e.strokeStyle="#000000",e.strokeText(i.name,t.x+4,t.y+11),e.strokeText(i.name,t.x+4,t.y+11),e.fillStyle="#FFA500",e.fillText(i.name,t.x+4,t.y+11)}}}}const Qe=async()=>{async function n(){await D.load(Se),await P.load(Pe),await Q.load(Ke)}async function e(){z.init(),S.init(),m.init(),j.init(),l.init(),w.render()}await n(),await e()};Qe();
