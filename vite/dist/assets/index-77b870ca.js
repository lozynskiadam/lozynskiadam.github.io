var ye=Object.defineProperty;var ve=(o,e,t)=>e in o?ye(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t;var w=(o,e,t)=>(ve(o,typeof e!="symbol"?e+"":e,t),t),ce=(o,e,t)=>{if(!e.has(o))throw TypeError("Cannot "+t)};var r=(o,e,t)=>(ce(o,e,"read from private field"),t?t.call(o):e.get(o)),C=(o,e,t)=>{if(e.has(o))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(o):e.set(o,t)},y=(o,e,t,s)=>(ce(o,e,"write to private field"),s?s.call(o,t):e.set(o,t),t);var ee=(o,e,t,s)=>({set _(i){y(o,e,i,t)},get _(){return r(o,e,s)}});(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const l of n.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&s(l)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();class v{static rand(e){return Math.floor(Math.random()*(e+1))}static roll(e){return!v.rand(e)}static randomColor(){return"#000000".replace(/0/g,function(){return(~~(Math.random()*16)).toString(16)})}static hexToRGB(e){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?[parseInt(t[1],16),parseInt(t[2],16),parseInt(t[3],16)]:null}static replaceColors(e,t){Object.keys(t).forEach(n=>{t[v.hexToRGB(n).toString()]=v.hexToRGB(t[n]),delete t[n]});const s=document.createElement("canvas").getContext("2d");s.canvas.width=e.width,s.canvas.height=e.height,s.drawImage(e,0,0);const i=s.getImageData(0,0,s.canvas.width,s.canvas.height);for(let n=0;n<i.data.length;n+=4){const l=[i.data[n],i.data[n+1],i.data[n+2]].toString();if(l in t){const u=t[l];i.data[n]=u[0],i.data[n+1]=u[1],i.data[n+2]=u[2],i.data[n+3]=255}}return s.putImageData(i,0,0),s.canvas}static async loadImage(e){return new Promise(t=>{const s=new Image;s.onload=()=>t(s),s.src=e})}static async dye(e,t,s){return new Promise(i=>{if(!t)return e;const n=["#ff0000","#ff00ff","#0000ff","#ffff00","#00ffff","#ff00ff"],l={};s.forEach((g,O)=>{l[n[O]]=g});const u=v.replaceColors(t,l),m=document.createElement("canvas").getContext("2d");m.canvas.width=e.width,m.canvas.height=e.height,m.drawImage(e,0,0),m.globalCompositeOperation="overlay",m.drawImage(u,0,0);const x=new Image;x.onload=()=>i(x),x.src=m.canvas.toDataURL("image/png")})}}var Z,se,R,N,X,A,E,K,Y,q,F,I,U;const j=class j{constructor(e,t){C(this,se,null);C(this,R,null);C(this,N,null);C(this,X,null);C(this,A,null);C(this,E,null);C(this,K,null);C(this,Y,null);C(this,q,null);C(this,F,null);C(this,I,null);C(this,U,null);e&&(r(j,Z)[e]=this),y(this,se,e),y(this,R,t.image),y(this,N,t.image),y(this,X,t.mask||null),y(this,A,t.speed||null),y(this,E,t.states||{}),r(this,E).origin=[{x:0,y:0,w:r(this,R).width,h:r(this,R).height}],y(this,K,document.createElement("canvas")),y(this,Y,r(this,K).getContext("2d")),y(this,F,this.getDefaultState()),y(this,I,1)}static async load(e){try{const s=await(await fetch(e)).json();await Promise.all(Object.entries(s).map(async([i,n])=>{const u={image:await v.loadImage(n.base),speed:n.speed||null,states:n.states||null};n.mask&&(u.mask=await v.loadImage(n.mask)),new j(i,u)}))}catch(t){console.error("Error loading sprites:",t)}}static get(e){return r(j,Z)[e]??null}clone(){return new j(null,{image:r(this,N),mask:r(this,X),speed:r(this,A),states:r(this,E)})}async play(e=null){return new Promise(t=>{e=e||this.getDefaultState(),this.stop(),this.rewind(),y(this,F,e);const s=r(this,E)[e].length;s>1&&r(this,A)&&y(this,q,setInterval(()=>{++ee(this,I)._>s&&(this.stop(),t())},r(this,A)))})}stop(){clearInterval(r(this,q)),y(this,q,null)}rewind(){y(this,I,1)}loop(e=null){if(e=e||this.getDefaultState(),r(this,q)&&r(this,F)===e)return;this.stop(),this.rewind(),y(this,F,e);const t=r(this,E)[e].length;t>1&&r(this,A)&&y(this,q,setInterval(()=>{++ee(this,I)._>t&&y(this,I,1)},r(this,A)))}async dye(e){y(this,R,await v.dye(r(this,N),r(this,X),e)),y(this,U,null)}getDefaultState(){return Object.keys(r(this,E))[0]}getFrame(){const e=r(this,E)[r(this,F)][r(this,I)-1];return r(this,U)===e?r(this,K):(y(this,U,e),r(this,K).width=e.w,r(this,K).height=e.h,r(this,Y).clearRect(0,0,r(this,K).width,r(this,K).height),r(this,Y).drawImage(r(this,R),e.x,e.y,e.w,e.h,0,0,e.w,e.h),r(this,K))}};Z=new WeakMap,se=new WeakMap,R=new WeakMap,N=new WeakMap,X=new WeakMap,A=new WeakMap,E=new WeakMap,K=new WeakMap,Y=new WeakMap,q=new WeakMap,F=new WeakMap,I=new WeakMap,U=new WeakMap,C(j,Z,{});let _=j;var $;const W=class W{constructor(e,t){w(this,"id",null);w(this,"name",null);w(this,"sprite",null);w(this,"type",null);w(this,"isBlockingCreatures",null);r(W,$)[e]=this,this.id=t.id,this.name=t.name,this.sprite=_.get(t.sprite),this.sprite.loop(),this.type=t.type,this.isBlockingCreatures=t.isBlockingCreatures}static async load(e){try{const s=await(await fetch(e)).json();return new Promise(i=>{Object.values(s).forEach(n=>{new W(n.id,n)}),i()})}catch(t){console.error("Error loading items:",t)}}static get(e){return r(W,$)[e]??null}};$=new WeakMap,C(W,$,{});let B=W;const p=32,he=33,ue=19,a=class a{static init(){a.sprite=_.get("outfit").clone(),a.sprite.dye([v.randomColor(),v.randomColor(),v.randomColor(),v.randomColor()]),a.sprite.loop("idle-south"),H.get("energy").run(a.position.x,a.position.y),window.addEventListener("move-north",()=>{a.walk("north")}),window.addEventListener("move-south",()=>{a.walk("south")}),window.addEventListener("move-west",()=>{a.walk("west")}),window.addEventListener("move-east",()=>{a.walk("east")}),window.addEventListener("randomize-outfit",()=>{a.sprite.dye([v.randomColor(),v.randomColor(),v.randomColor(),v.randomColor()])})}static setPosition(e,t){a.position={x:e,y:t},a.movement.timeouts.forEach(s=>clearTimeout(s)),a.movement.timeouts=[],a.movement.queuedMove=null,a.movement.isMoving=!1,a.movement.currentFrame=0,window.dispatchEvent(new CustomEvent("hero-position-changed"))}static walk(e){if(a.movement.isMoving)return a.movement.currentFrame>p-p/3?(a.movement.queuedMove=e,!0):!1;const t=a.getTargetPosition(e);if(!f.isWalkable(t.x,t.y))return a.sprite.loop("idle-"+e),!1;a.movement.isMoving=!0;for(let s=0;s<p;s++){const i=setTimeout(()=>a.handleWalkFrame(e,t),1e3/a.speed/p*s);a.movement.timeouts.push(i)}return!0}static handleWalkFrame(e,t){a.sprite.loop("walk-"+e),a.movement.currentFrame++,a.updateOffsetAfterAnimationFrameChange(e),a.movement.currentFrame===p/2&&(a.position=t,window.dispatchEvent(new CustomEvent("hero-position-changed")),a.updateOffsetAfterPositionChange(e)),a.movement.currentFrame===p&&(a.movement.isMoving=!1,a.movement.currentFrame=0,a.movement.timeouts.forEach(s=>clearTimeout(s)),a.movement.timeouts=[],a.movement.queuedMove?(e=a.movement.queuedMove,a.movement.queuedMove=null,a.walk(e)||a.sprite.loop("idle-"+e)):a.sprite.loop("idle-"+e))}static getTargetPosition(e){const t={north:{x:0,y:-1},south:{x:0,y:1},west:{x:-1,y:0},east:{x:1,y:0}};return{x:a.position.x+t[e].x,y:a.position.y+t[e].y}}static updateOffsetAfterAnimationFrameChange(e){({north:()=>a.offset.y--,south:()=>a.offset.y++,west:()=>a.offset.x--,east:()=>a.offset.x++})[e]()}static updateOffsetAfterPositionChange(e){({north:()=>a.offset.y=p/2,south:()=>a.offset.y=-(p/2),west:()=>a.offset.x=p/2,east:()=>a.offset.x=-(p/2)})[e]()}};w(a,"position",{x:100,y:100}),w(a,"offset",{x:0,y:0}),w(a,"sprite",null),w(a,"speed",2),w(a,"movement",{queuedMove:null,isMoving:!1,currentFrame:0,timeouts:[]});let b=a;const c=class c{static init(){const e=document.createElement("canvas");e.id="board",e.width=p*he,e.height=p*ue,document.querySelector("#app").append(e),c.ctx=e.getContext("2d"),c.width=he,c.height=ue,c.update(),window.addEventListener("hero-position-changed",()=>{c.update()})}static update(){const e=b.position.x-Math.floor(c.width/2),t=b.position.x+Math.floor(c.width/2),s=b.position.y-Math.floor(c.height/2),i=b.position.y+Math.floor(c.height/2),n=[],l={};for(let u=s;u<=i;u++)for(let m=e;m<=t;m++)l[u]=l[u]||{},c.tiles[u]&&c.tiles[u][m]?l[u][m]=c.tiles[u][m]:(l[u][m]=[],n.push({x:m,y:u}));c.tiles=l,c.requestTiles(n)}static getTileStack(e,t){return typeof c.tiles[t]>"u"||typeof c.tiles[t][e]>"u"?[]:c.tiles[t][e]}static getTileTopItem(e,t){const s=c.getTileStack(e,t);return s[s.length-1]??null}static updateTile(e,t,s){typeof c.tiles[t]<"u"&&typeof c.tiles[t][e]<"u"&&(c.tiles[t][e]=s)}static requestTiles(e){setTimeout(()=>{for(const t of e){const s=t.x,i=t.y,n=[];v.roll(40)?n.push(2):v.roll(40)?n.push(3):v.roll(5)?n.push(4):n.push(1),s===b.position.x&&i===b.position.y||(v.roll(30)?n.push(5):v.roll(75)?n.push(6):v.roll(10)?n.push(7):v.roll(30)&&n.push(8)),c.updateTile(s,i,n)}},100)}static isWalkable(e,t){const s=c.getTileStack(e,t);return!(!s.find(i=>B.get(i).type==="ground")||s.find(i=>B.get(i).isBlockingCreatures))}static positionLocalToServer(e,t){const s=b.position.x-Math.floor(c.width/2),i=b.position.y-Math.floor(c.height/2);return{x:s+e,y:i+t}}static getEffects(e,t){return c.effects&&c.effects[t]&&c.effects[t][e]?Object.values(this.effects[t][e]):[]}};w(c,"ctx",null),w(c,"width",null),w(c,"height",null),w(c,"tiles",{}),w(c,"effects",{});let f=c;var J,ie,ne,V;const L=class L{constructor(e,t){C(this,ne,null);C(this,V,null);r(L,J)[e]=this,y(this,ne,e),y(this,V,t)}static async load(e){try{const s=await(await fetch(e)).json();return new Promise(i=>{Object.values(s).forEach(n=>{new L(n.id,_.get(n.sprite))}),i()})}catch(t){console.error("Error loading effects:",t)}}static get(e){return r(L,J)[e]??null}run(e,t){f.effects[t]||(f.effects[t]={}),f.effects[t][e]||(f.effects[t][e]={});const s=++ee(L,ie)._,i=r(this,V).clone();f.effects[t][e][s]=i,i.play().then(()=>{delete f.effects[t][e][s]})}};J=new WeakMap,ie=new WeakMap,ne=new WeakMap,V=new WeakMap,C(L,J,{}),C(L,ie,0);let H=L;var ge=Object.defineProperty,we=(o,e,t)=>e in o?ge(o,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):o[e]=t,d=(o,e,t)=>(we(o,typeof e!="symbol"?e+"":e,t),t);class fe{constructor(e){d(this,"_onPressed"),d(this,"_onPressedWithRepeat"),d(this,"_onReleased"),d(this,"_isPressed"),d(this,"_identity"),this._isPressed=!1,this._identity=e,typeof e=="function"?this._onPressedWithRepeat=e:(this._onPressed=e.onPressed,this._onPressedWithRepeat=e.onPressedWithRepeat,this._onReleased=e.onReleased)}get isEmpty(){return!this._onPressed&&!this._onPressedWithRepeat&&!this._onReleased}isOwnHandler(e){return this._identity===e}executePressed(e){var t,s;this._isPressed||(t=this._onPressed)==null||t.call(this,e),this._isPressed=!0,(s=this._onPressedWithRepeat)==null||s.call(this,e)}executeReleased(e){var t;this._isPressed&&((t=this._onReleased)==null||t.call(this,e)),this._isPressed=!1}}const oe=class S{constructor(e,t,s={}){d(this,"_normalizedKeyCombo"),d(this,"_parsedKeyCombo"),d(this,"_handlerState"),d(this,"_keyComboEventMapper"),d(this,"_movingToNextSequenceAt"),d(this,"_sequenceIndex"),d(this,"_unitIndex"),d(this,"_lastActiveKeyPresses"),d(this,"_lastActiveKeyCount"),d(this,"_isPressedWithFinalUnit"),this._normalizedKeyCombo=S.normalizeKeyCombo(e),this._parsedKeyCombo=S.parseKeyCombo(e),this._handlerState=new fe(s),this._keyComboEventMapper=t,this._movingToNextSequenceAt=0,this._sequenceIndex=0,this._unitIndex=0,this._lastActiveKeyPresses=[],this._lastActiveKeyCount=0,this._isPressedWithFinalUnit=null}static parseKeyCombo(e){if(S._parseCache[e])return S._parseCache[e];const t=e.toLowerCase();let s="",i=[],n=[i],l=[n];const u=[l];let m=!1;for(let g=0;g<e.length;g+=1)if(t[g]==="\\")m=!0;else if((t[g]==="+"||t[g]===">"||t[g]===",")&&!m){if(s)throw new Error("cannot have two operators in a row");s=t[g]}else t[g].match(/[^\s]/)&&(s&&(s===","?(i=[],n=[i],l=[n],u.push(l)):s===">"?(i=[],n=[i],l.push(n)):s==="+"&&(i=[],n.push(i)),s=""),m=!1,i.push(t[g]));const x=u.map(g=>g.map(O=>O.map(D=>D.join(""))));return S._parseCache[e]=x,x}static stringifyKeyCombo(e){return e.map(t=>t.map(s=>s.map(i=>i==="+"?"\\+":i===">"?"\\>":i===","?"\\,":i).join("+")).join(">")).join(",")}static normalizeKeyCombo(e){if(S._normalizationCache[e])return S._normalizationCache[e];const t=this.stringifyKeyCombo(this.parseKeyCombo(e));return S._normalizationCache[e]=t,t}get isPressed(){return!!this._isPressedWithFinalUnit}get sequenceIndex(){return this.isPressed?this._parsedKeyCombo.length:this._sequenceIndex}isOwnHandler(e){return this._handlerState.isOwnHandler(e)}executePressed(e){var t;(t=this._isPressedWithFinalUnit)!=null&&t.has(e.key)&&this._handlerState.executePressed(this._wrapEvent(this._lastActiveKeyPresses,{key:e.key,event:e}))}executeReleased(e){var t;(t=this._isPressedWithFinalUnit)!=null&&t.has(e.key)&&(this._handlerState.executeReleased(this._wrapEvent(this._lastActiveKeyPresses,{key:e.key,event:e})),this._isPressedWithFinalUnit=null)}updateState(e,t){const s=e.length,i=s<this._lastActiveKeyCount;this._lastActiveKeyCount=s;const n=this._parsedKeyCombo[this._sequenceIndex],l=n.slice(0,this._unitIndex),u=n.slice(this._unitIndex),m=()=>{this._movingToNextSequenceAt=0,this._sequenceIndex=0,this._unitIndex=0,this._lastActiveKeyPresses.length=0,this._handlerState.isEmpty&&(this._isPressedWithFinalUnit=null)};let x=0;if(i){if(this._movingToNextSequenceAt===0)return m();if(this._movingToNextSequenceAt+t<Date.now()||s!==0)return;this._movingToNextSequenceAt=0,this._sequenceIndex+=1,this._unitIndex=0;return}for(const g of l){for(const O of g){let D=!1;for(let P=x;P<e.length&&P<x+g.length;P+=1)if(e[P].key===O){D=!0;break}if(!D)return m()}x+=g.length}if(this._movingToNextSequenceAt===0){for(const g of u){for(const O of g){let D=!1;for(let P=x;P<e.length&&P<x+g.length;P+=1)if(e[P].key===O){D=!0;break}if(!D)return}this._unitIndex+=1,x+=g.length}if(x<s-1)return m();if(this._lastActiveKeyPresses[this._sequenceIndex]=e.slice(0),this._sequenceIndex<this._parsedKeyCombo.length-1){this._movingToNextSequenceAt=Date.now();return}this._isPressedWithFinalUnit=new Set(n[n.length-1])}}_wrapEvent(e,t){return{...this._keyComboEventMapper(e,t),keyCombo:this._normalizedKeyCombo,keyEvents:e.flat().map(s=>s.event),finalKeyEvent:t.event}}};d(oe,"_parseCache",{}),d(oe,"_normalizationCache",{});let M=oe;const Ce={addEventListener:(...o)=>{},removeEventListener:(...o)=>{},dispatchEvent:(...o)=>{}},be={userAgent:""},Q=()=>typeof document<"u"?document:Ce,ke=()=>typeof navigator<"u"?navigator:be,xe=()=>ke().userAgent.toLocaleLowerCase().includes("mac");let ae=!1;const Ke=o=>{!xe()||o.key!=="Meta"||(ae=!0)},Ee=o=>{!ae||o.key!=="Meta"||(ae=!1,me())},te=new Map,Pe=o=>{te.set(o.key,o)},Se=o=>{te.delete(o.key)},me=()=>{for(const o of te.values()){const e=new KeyboardEvent("keyup",{key:o.key,code:o.code,bubbles:!0,cancelable:!0});Q().dispatchEvent(e)}te.clear()},Ae=o=>{try{const e=()=>o();return addEventListener("focus",e),()=>{removeEventListener("focus",e)}}catch{}},Ie=o=>{try{const e=()=>{me(),o()};return addEventListener("blur",e),()=>removeEventListener("blur",e)}catch{}},Te=o=>{try{const e=t=>(Pe(t),Ke(t),o({key:t.key,originalEvent:t,composedPath:()=>t.composedPath(),preventDefault:()=>t.preventDefault()}));return Q().addEventListener("keydown",e),()=>Q().removeEventListener("keydown",e)}catch{}},Le=o=>{try{const e=t=>(Se(t),Ee(t),o({key:t.key,originalEvent:t,composedPath:()=>t.composedPath(),preventDefault:()=>t.preventDefault()}));return Q().addEventListener("keyup",e),()=>Q().removeEventListener("keyup",e)}catch{}},Me=1e3;class Re{constructor(e={}){d(this,"sequenceTimeout"),d(this,"_isActive"),d(this,"_unbinder"),d(this,"_onActiveBinder"),d(this,"_onInactiveBinder"),d(this,"_onKeyPressedBinder"),d(this,"_onKeyReleasedBinder"),d(this,"_keyComboEventMapper"),d(this,"_selfReleasingKeys"),d(this,"_keyRemap"),d(this,"_handlerStates"),d(this,"_keyComboStates"),d(this,"_keyComboStatesArray"),d(this,"_activeKeyPresses"),d(this,"_activeKeyMap"),d(this,"_watchedKeyComboStates"),this.sequenceTimeout=Me,this._isActive=!0,this._onActiveBinder=()=>{},this._onInactiveBinder=()=>{},this._onKeyPressedBinder=()=>{},this._onKeyReleasedBinder=()=>{},this._keyComboEventMapper=()=>({}),this._selfReleasingKeys=[],this._keyRemap={},this._handlerStates={},this._keyComboStates={},this._keyComboStatesArray=[],this._activeKeyPresses=[],this._activeKeyMap=new Map,this._watchedKeyComboStates={},this.bindEnvironment(e)}get pressedKeys(){return this._activeKeyPresses.map(e=>e.key)}bindKey(e,t){var s;e=e.toLowerCase();const i=new fe(t);(s=this._handlerStates)[e]??(s[e]=[]),this._handlerStates[e].push(i)}unbindKey(e,t){e=e.toLowerCase();const s=this._handlerStates[e];if(s)if(t)for(let i=0;i<s.length;i+=1)s[i].isOwnHandler(t)&&(s.splice(i,1),i-=1);else s.length=0}bindKeyCombo(e,t){var s;e=M.normalizeKeyCombo(e);const i=new M(e,this._keyComboEventMapper,t);(s=this._keyComboStates)[e]??(s[e]=[]),this._keyComboStates[e].push(i),this._keyComboStatesArray.push(i)}unbindKeyCombo(e,t){e=M.normalizeKeyCombo(e);const s=this._keyComboStates[e];if(s)if(t){for(let i=0;i<s.length;i+=1)if(s[i].isOwnHandler(t)){for(let n=0;n<this._keyComboStatesArray.length;n+=1)this._keyComboStatesArray[n]===s[i]&&(this._keyComboStatesArray.splice(n,1),n-=1);s.splice(i,1),i-=1}}else s.length=0}checkKey(e){return this._activeKeyMap.has(e.toLowerCase())}checkKeyCombo(e){return this._ensureCachedKeyComboState(e).isPressed}checkKeyComboSequenceIndex(e){return this._ensureCachedKeyComboState(e).sequenceIndex}bindEnvironment(e={}){this.unbindEnvironment(),this._onActiveBinder=e.onActive??Ae,this._onInactiveBinder=e.onInactive??Ie,this._onKeyPressedBinder=e.onKeyPressed??Te,this._onKeyReleasedBinder=e.onKeyReleased??Le,this._keyComboEventMapper=e.mapKeyComboEvent??(()=>({})),this._selfReleasingKeys=e.selfReleasingKeys??[],this._keyRemap=e.keyRemap??{};const t=this._onActiveBinder(()=>{this._isActive=!0}),s=this._onInactiveBinder(()=>{this._isActive=!1}),i=this._onKeyPressedBinder(l=>{this._handleKeyPress(l)}),n=this._onKeyReleasedBinder(l=>{this._handleKeyRelease(l)});this._unbinder=()=>{t==null||t(),s==null||s(),i==null||i(),n==null||n()}}unbindEnvironment(){var e;(e=this._unbinder)==null||e.call(this)}_ensureCachedKeyComboState(e){e=M.normalizeKeyCombo(e),this._watchedKeyComboStates[e]||(this._watchedKeyComboStates[e]=new M(e,this._keyComboEventMapper));const t=this._watchedKeyComboStates[e];return t.updateState(this._activeKeyPresses,this.sequenceTimeout),t}_handleKeyPress(e){if(!this._isActive)return;e={...e,key:e.key.toLowerCase()};const t=this._keyRemap[e.key];t&&(e.key=t);const s=this._handlerStates[e.key];if(s)for(const n of s)n.executePressed(e);const i=this._activeKeyMap.get(e.key);if(i)i.event=e;else{const n={key:e.key,event:e};this._activeKeyMap.set(e.key,n),this._activeKeyPresses.push(n)}this._updateKeyComboStates();for(const n of this._keyComboStatesArray)n.executePressed(e)}_handleKeyRelease(e){e={...e,key:e.key.toLowerCase()};const t=this._keyRemap[e.key];t&&(e.key=t);const s=this._handlerStates[e.key];if(s)for(const i of s)i.executeReleased(e);if(this._activeKeyMap.has(e.key)){this._activeKeyMap.delete(e.key);for(let i=0;i<this._activeKeyPresses.length;i+=1)if(this._activeKeyPresses[i].key===e.key){this._activeKeyPresses.splice(i,1),i-=1;break}}this._tryReleaseSelfReleasingKeys(),this._updateKeyComboStates();for(const i of this._keyComboStatesArray)i.executeReleased(e)}_updateKeyComboStates(){for(const e of this._keyComboStatesArray)e.updateState(this._activeKeyPresses,this.sequenceTimeout)}_tryReleaseSelfReleasingKeys(){for(const e of this._activeKeyPresses)for(const t of this._selfReleasingKeys)e.key===t&&this._handleKeyRelease(e.event)}}let qe,re;const Fe=o=>{re=o??new Re(qe)},pe=()=>(re||Fe(),re),de=(...o)=>pe().bindKey(...o),T=(...o)=>pe().checkKey(...o);M.normalizeKeyCombo;M.stringifyKeyCombo;M.parseKeyCombo;const G=class G{static init(){document.addEventListener("keydown",()=>setTimeout(G.triggerKeyHoldingFunctions)),window.keyboardLoop=setInterval(G.triggerKeyHoldingFunctions,200),de(" ",()=>window.dispatchEvent(new CustomEvent("randomize-outfit"))),de("Spacebar",()=>window.dispatchEvent(new CustomEvent("randomize-outfit")))}};w(G,"triggerKeyHoldingFunctions",()=>{(T("ArrowUp")||T("w"))&&window.dispatchEvent(new CustomEvent("move-north")),(T("ArrowDown")||T("s"))&&window.dispatchEvent(new CustomEvent("move-south")),(T("ArrowLeft")||T("a"))&&window.dispatchEvent(new CustomEvent("move-west")),(T("ArrowRight")||T("d"))&&window.dispatchEvent(new CustomEvent("move-east"))});let le=G;const h=class h{static init(){document.addEventListener("mousemove",h.onMove,!1),document.addEventListener("mousedown",e=>{(e.which===1||e.button===0)&&(h.buttons.left.isDown=!0,h.onLeftButtonClick()),(e.which===3||e.button===2)&&(h.buttons.right.isDown=!0)}),document.addEventListener("mouseup",e=>{(e.which===1||e.button===0)&&(h.buttons.left.isDown=!1),(e.which===3||e.button===2)&&(h.buttons.right.isDown=!1)}),document.addEventListener("contextmenu",e=>(e==null?void 0:e.cancelable)&&e.preventDefault())}static onMove(e){const t=f.ctx.canvas.getBoundingClientRect(),s={...h.position};h.position.clientX=e.clientX,h.position.clientY=e.clientY,h.position.x=Math.floor(((e.clientX-t.left)/(t.right-t.left)*f.ctx.canvas.width+b.offset.x)/p),h.position.y=Math.floor(((e.clientY-t.top)/(t.bottom-t.top)*f.ctx.canvas.height+b.offset.y)/p);const i=f.positionLocalToServer(h.position.x,h.position.y);h.position.serverX=i.x,h.position.serverY=i.y,(h.position.x!==s.x||h.position.y!==s.y)&&h.onPositionChange(s),(h.position.serverX!==s.serverX||h.position.serverY!==s.serverY)&&h.onPositionChange(s)}static onPositionChange(){const e=f.positionLocalToServer(h.position.x,h.position.y),t=f.getTileTopItem(e.x,e.y);if(!t){f.ctx.canvas.removeAttribute("cursor");return}t===6?f.ctx.canvas.setAttribute("cursor","chest"):t===8?f.ctx.canvas.setAttribute("cursor","pick"):f.ctx.canvas.removeAttribute("cursor")}static onLeftButtonClick(){if(h.buttons.left.isBlocked)return;const e=f.positionLocalToServer(h.position.x,h.position.y),t=f.getTileTopItem(e.x,e.y);if(t){if(t===6){h.buttons.left.isBlocked=!0,H.get("yellow-sparkles").run(e.x,e.y),f.tiles[e.y][e.x].pop(),setTimeout(()=>{h.buttons.left.isBlocked=!1},600);return}if(t===8){h.buttons.left.isBlocked=!0,H.get("ore-hit").run(e.x,e.y),setTimeout(()=>{h.buttons.left.isBlocked=!1},600);return}}}static onRightButtonClick(){}};w(h,"position",{x:null,y:null,clientX:null,clientY:null,serverX:null,serverY:null}),w(h,"buttons",{left:{isBlocked:!1,isDown:!1},right:{isBlocked:!1,isDown:!1}});let z=h;class k{static renderTile(e,t,s,i,n,l){n==="ground"&&l.forEach(u=>{B.get(u).type==="ground"&&k.drawSprite(B.get(u).sprite.getFrame(),e,t)}),n==="objects"&&(z.buttons.right.isDown&&z.position.x===e&&z.position.y===t&&k.drawSprite(_.get("cursor").getFrame(),e,t),l.forEach(u=>{const m=B.get(u);m.type==="object"&&k.drawSprite(m.sprite.getFrame(),e,t)}),s===b.position.x&&i===b.position.y&&k.drawCreature({sprite:b.sprite,offset:b.offset},e,t),f.getEffects(s,i).forEach(u=>{k.drawSprite(u.getFrame(),e,t)}))}static drawSprite(e,t,s){let i=s*p+(p-e.height),n=t*p+(Math.ceil(p/2)-Math.ceil(e.width/2));k.tempCtx.drawImage(e,n,i)}static drawCreature(e,t,s){let i=e.sprite.getFrame(),n=s*p+(p-i.height)+e.offset.y,l=t*p+(Math.ceil(p/2)-Math.ceil(i.width/2))+e.offset.x;k.tempCtx.drawImage(i,l,n)}static cropEdges(e){e.clearRect(0,0,p,e.canvas.height),e.clearRect(0,0,e.canvas.width,p),e.clearRect(e.canvas.width-p,0,e.canvas.width,e.canvas.height),e.clearRect(0,e.canvas.height-p,e.canvas.width,e.canvas.height)}static render(){const e=document.createElement("canvas");e.width=f.ctx.canvas.width,e.height=f.ctx.canvas.height,k.tempCtx=e.getContext("2d"),k.tempCtx.fillStyle="#25131a",k.tempCtx.fillRect(0,0,k.tempCtx.canvas.width,k.tempCtx.canvas.height);for(let t of["ground","objects"]){let s=0;for(let[i,n]of Object.entries(f.tiles)){let l=0;for(let[u,m]of Object.entries(n))k.renderTile(l,s,Number(u),Number(i),t,m),l++;s++}}f.ctx.clearRect(0,0,f.ctx.canvas.width,f.ctx.canvas.height),f.ctx.drawImage(e,-b.offset.x,-b.offset.y),k.cropEdges(f.ctx),window.requestAnimationFrame(k.render)}}const Be=async()=>{async function o(){await _.load("data/sprites.json"),await B.load("data/items.json"),await H.load("data/effects.json")}async function e(){le.init(),z.init(),b.init(),f.init(),k.render()}await o(),await e()};Be();
