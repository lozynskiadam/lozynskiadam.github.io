var ge=Object.defineProperty;var ve=(r,e,t)=>e in r?ge(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var m=(r,e,t)=>(ve(r,typeof e!="symbol"?e+"":e,t),t),he=(r,e,t)=>{if(!e.has(r))throw TypeError("Cannot "+t)};var c=(r,e,t)=>(he(r,e,"read from private field"),t?t.call(r):e.get(r)),b=(r,e,t)=>{if(e.has(r))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(r):e.set(r,t)},p=(r,e,t,s)=>(he(r,e,"write to private field"),s?s.call(r,t):e.set(r,t),t);var se=(r,e,t,s)=>({set _(i){p(r,e,i,t)},get _(){return c(r,e,s)}});(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const n of i)if(n.type==="childList")for(const h of n.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&s(h)}).observe(document,{childList:!0,subtree:!0});function t(i){const n={};return i.integrity&&(n.integrity=i.integrity),i.referrerPolicy&&(n.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?n.credentials="include":i.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function s(i){if(i.ep)return;i.ep=!0;const n=t(i);fetch(i.href,n)}})();const d=32,ue=33,de=19,we="data/sprites.json",be="data/items.json",Ce="data/effects.json";class g{static rand(e){return Math.floor(Math.random()*(e+1))}static roll(e){return g.rand(e)===e}static randomString(e){return window.btoa(String.fromCharCode(...window.crypto.getRandomValues(new Uint8Array(e*2)))).replace(/[+/]/g,"").substring(0,e)}static randomColor(){return"#000000".replace(/0/g,function(){return(~~(Math.random()*16)).toString(16)})}static hexToRGB(e){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?[parseInt(t[1],16),parseInt(t[2],16),parseInt(t[3],16)]:null}static areEqual(...e){return e.length>=2&&e.slice(1).every(t=>Object.keys(e[0]).length===Object.keys(t).length&&Object.keys(e[0]).every(s=>e[0][s]===t[s]))}static replaceColors(e,t){Object.keys(t).forEach(n=>{t[g.hexToRGB(n).toString()]=g.hexToRGB(t[n]),delete t[n]});const s=document.createElement("canvas").getContext("2d");s.canvas.width=e.width,s.canvas.height=e.height,s.drawImage(e,0,0);const i=s.getImageData(0,0,s.canvas.width,s.canvas.height);for(let n=0;n<i.data.length;n+=4){const h=[i.data[n],i.data[n+1],i.data[n+2]].toString();if(h in t){const f=t[h];i.data[n]=f[0],i.data[n+1]=f[1],i.data[n+2]=f[2],i.data[n+3]=255}}return s.putImageData(i,0,0),s.canvas}static async loadImage(e){return new Promise(t=>{const s=new Image;s.onload=()=>t(s),s.src=e})}static async dye(e,t,s){return new Promise(i=>{if(!t)return e;const n=["#ff0000","#ff00ff","#0000ff","#ffff00","#00ffff","#ff00ff"],h={};s.forEach((v,W)=>{h[n[W]]=v});const f=g.replaceColors(t,h),w=document.createElement("canvas").getContext("2d");w.canvas.width=e.width,w.canvas.height=e.height,w.drawImage(e,0,0),w.globalCompositeOperation="overlay",w.drawImage(f,0,0);const k=new Image;k.onload=()=>i(k),k.src=w.canvas.toDataURL("image/png")})}}var $,ne,O,Y,U,T,E,P,G,B,j,R,Q;const H=class H{constructor(e,t){b(this,ne,null);b(this,O,null);b(this,Y,null);b(this,U,null);b(this,T,null);b(this,E,null);b(this,P,null);b(this,G,null);b(this,B,null);b(this,j,null);b(this,R,null);b(this,Q,null);e&&(c(H,$)[e]=this),p(this,ne,e),p(this,O,t.image),p(this,Y,t.image),p(this,U,t.mask||null),p(this,T,t.speed||null),p(this,E,t.states||{}),c(this,E).origin=[{x:0,y:0,w:c(this,O).width,h:c(this,O).height}],p(this,P,document.createElement("canvas")),p(this,G,c(this,P).getContext("2d")),p(this,j,this.getDefaultState()),p(this,R,1)}static async load(e){try{const s=await(await fetch(e)).json();await Promise.all(Object.entries(s).map(async([i,n])=>{const f={image:await g.loadImage(n.base),speed:n.speed||null,states:n.states||null};n.mask&&(f.mask=await g.loadImage(n.mask)),new H(i,f)}))}catch(t){console.error("Error loading sprites:",t)}}static get(e){return c(H,$)[e]??null}clone(){return new H(null,{image:c(this,Y),mask:c(this,U),speed:c(this,T),states:c(this,E)})}async play(e=null){return new Promise(t=>{e=e||this.getDefaultState(),this.stop(),this.rewind(),p(this,j,e);const s=c(this,E)[e].length;s>1&&c(this,T)&&p(this,B,setInterval(()=>{++se(this,R)._>s&&(this.stop(),t())},c(this,T)))})}stop(){clearInterval(c(this,B)),p(this,B,null)}rewind(){p(this,R,1)}loop(e=null){if(e=e||this.getDefaultState(),c(this,B)&&c(this,j)===e)return;this.stop(),this.rewind(),p(this,j,e);const t=c(this,E)[e].length;t>1&&c(this,T)&&p(this,B,setInterval(()=>{++se(this,R)._>t&&p(this,R,1)},c(this,T)))}async dye(e){p(this,O,await g.dye(c(this,Y),c(this,U),e)),p(this,Q,null)}getDefaultState(){return Object.keys(c(this,E))[0]}getFrame(){const e=c(this,E)[c(this,j)][c(this,R)-1];return c(this,Q)===e?c(this,P):(p(this,Q,e),c(this,P).width=e.w,c(this,P).height=e.h,c(this,G).clearRect(0,0,c(this,P).width,c(this,P).height),c(this,G).drawImage(c(this,O),e.x,e.y,e.w,e.h,0,0,e.w,e.h),c(this,P))}};$=new WeakMap,ne=new WeakMap,O=new WeakMap,Y=new WeakMap,U=new WeakMap,T=new WeakMap,E=new WeakMap,P=new WeakMap,G=new WeakMap,B=new WeakMap,j=new WeakMap,R=new WeakMap,Q=new WeakMap,b(H,$,{});let z=H;var J;const X=class X{constructor(e,t){m(this,"id",null);m(this,"name",null);m(this,"sprite",null);m(this,"type",null);m(this,"isBlockingCreatures",null);m(this,"isMoveable",null);c(X,J)[e]=this,this.id=t.id,this.name=t.name,this.sprite=z.get(t.sprite),this.sprite.loop(),this.type=t.type,this.isBlockingCreatures=t.isBlockingCreatures,this.isMoveable=t.isMoveable}static async load(e){try{const s=await(await fetch(e)).json();return new Promise(i=>{Object.values(s).forEach(n=>{new X(n.id,n)}),i()})}catch(t){console.error("Error loading items:",t)}}static get(e){return c(X,J)[e]??null}};J=new WeakMap,b(X,J,{});let K=X;class D{static init(){window.addEventListener("move-north",()=>y.walk("north")),window.addEventListener("move-south",()=>y.walk("south")),window.addEventListener("move-west",()=>y.walk("west")),window.addEventListener("move-east",()=>y.walk("east"))}static move(e,t,s){e.movement.timeouts.forEach(i=>clearTimeout(i)),e.movement.timeouts=[],e.currentFrame=0,e.offset={x:0,y:0},e.movement.isMoving=!0;for(let i=0;i<d;i++){const n=setTimeout(()=>D.handleMovingFrame(e,t,s),1e3/e.speed/d*i);e.movement.timeouts.push(n)}}static handleMovingFrame(e,t,s){if(e.sprite.loop("walk-"+s),e.movement.currentFrame++,D.updateOffsetAfterAnimationFrameChange(e,s),e.movement.currentFrame===d/2&&(e.position=t,window.dispatchEvent(new CustomEvent("hero-position-changed")),D.updateOffsetAfterPositionChange(e,s)),e.movement.currentFrame===d){if(e.movement.isMoving=!1,e.movement.currentFrame=0,e.movement.timeouts.forEach(i=>clearTimeout(i)),e.movement.timeouts=[],e.isHero()&&y.queuedMove&&(s=y.queuedMove,y.queuedMove=null,y.walk(s)))return;e.sprite.loop("idle-"+s)}}static getTargetPosition(e,t){const s={north:{x:0,y:-1},south:{x:0,y:1},west:{x:-1,y:0},east:{x:1,y:0}};return{x:e.position.x+s[t].x,y:e.position.y+s[t].y}}static updateOffsetAfterAnimationFrameChange(e,t){({north:()=>e.offset.y--,south:()=>e.offset.y++,west:()=>e.offset.x--,east:()=>e.offset.x++})[t]()}static updateOffsetAfterPositionChange(e,t){({north:()=>e.offset.y=d/2,south:()=>e.offset.y=-(d/2),west:()=>e.offset.x=d/2,east:()=>e.offset.x=-(d/2)})[t]()}}class fe{constructor(e,t,s){m(this,"position",{x:null,y:null});m(this,"offset",{x:null,y:null});m(this,"sprite",null);m(this,"speed",2);m(this,"movement",{isMoving:!1,currentFrame:0,timeouts:[]});l.creatures[e]=this,this.position=t,this.offset=s,this.sprite=z.get("outfit").clone(),this.sprite.dye([g.randomColor(),g.randomColor(),g.randomColor(),g.randomColor()]),this.sprite.loop("idle-south")}isHero(){return this===y.creature}move(e,t){D.move(this,t,e)}}const S=class S{static init(){S.creature=new fe("Nemnes",{x:100,y:100},{x:0,y:0}),V.get("energy").run(S.creature.position)}static walk(e){if(S.creature.movement.isMoving)return S.creature.movement.currentFrame>d-d/3?(S.queuedMove=e,!0):!1;const t=D.getTargetPosition(S.creature,e);return l.isWalkable(t)?(D.move(this.creature,t,e),!0):(S.creature.sprite.loop("idle-"+e),!1)}};m(S,"creature",null),m(S,"queuedMove",null);let y=S;const a=class a{static init(){const e=document.createElement("canvas");e.id="board",e.width=d*ue,e.height=d*de,document.querySelector("#app").append(e),a.ctx=e.getContext("2d"),a.width=ue,a.height=de,a.update(),window.addEventListener("hero-position-changed",()=>{a.update()})}static update(){a.area.fromX=y.creature.position.x-Math.floor(a.width/2),a.area.toX=y.creature.position.x+Math.floor(a.width/2),a.area.fromY=y.creature.position.y-Math.floor(a.height/2),a.area.toY=y.creature.position.y+Math.floor(a.height/2);for(const[s,i]of Object.entries(a.creatures))a.isOnArea(i.position.x,i.position.y)||delete a.creatures[s];const e=[],t={};for(let s=a.area.fromY;s<=a.area.toY;s++)for(let i=a.area.fromX;i<=a.area.toX;i++)t[s]=t[s]||{},a.tiles[s]&&a.tiles[s][i]?t[s][i]=a.tiles[s][i]:(t[s][i]=[],e.push({x:i,y:s}));a.tiles=t,a.requestTiles(e)}static getTileStack(e){return typeof a.tiles[e.y]>"u"||typeof a.tiles[e.y][e.x]>"u"?[]:a.tiles[e.y][e.x]}static getTileTopItem(e){const t=a.getTileStack(e);return t[t.length-1]??null}static updateTile(e,t){typeof a.tiles[e.y]<"u"&&typeof a.tiles[e.y][e.x]<"u"&&(a.tiles[e.y][e.x]=t)}static requestTiles(e){setTimeout(()=>{for(const t of e){const s=[];g.roll(40)?s.push(2):g.roll(40)?s.push(3):g.roll(30)?s.push(4):s.push(1),g.areEqual(t,y.creature.position)||(g.roll(100)?s.push(6):g.roll(100)&&s.push(8)),a.updateTile(t,s),g.roll(350)&&new fe(g.randomString(20),t,{x:0,y:0})}},100)}static isWalkable(e){const t=a.getTileStack(e);return!(!t.find(s=>K.get(s).type==="ground")||t.find(s=>K.get(s).isBlockingCreatures))}static isInHeroRange(e,t=1){const s=y.creature.position.x-t,i=y.creature.position.y-t,n=y.creature.position.x+t,h=y.creature.position.y+t;return e.x>=s&&e.x<=n&&e.y>=i&&e.y<=h}static isOnArea(e,t){return e>=a.area.fromX&&e<=a.area.toX&&t>=a.area.fromY&&t<=a.area.toY}static positionLocalToServer(e){return{x:a.area.fromX+e.x,y:a.area.fromY+e.y}}static getEffects(e,t){return a.effects&&a.effects[t]&&a.effects[t][e]?Object.values(this.effects[t][e]):[]}};m(a,"ctx",null),m(a,"width",null),m(a,"height",null),m(a,"tiles",{}),m(a,"effects",{}),m(a,"creatures",{}),m(a,"area",{fromX:null,fromY:null,toX:null,toY:null});let l=a;var ee,oe,re,te;const L=class L{constructor(e,t){b(this,re,null);b(this,te,null);c(L,ee)[e]=this,p(this,re,e),p(this,te,t)}static async load(e){try{const s=await(await fetch(e)).json();return new Promise(i=>{Object.values(s).forEach(n=>{new L(n.id,z.get(n.sprite))}),i()})}catch(t){console.error("Error loading effects:",t)}}static get(e){return c(L,ee)[e]??null}run(e){l.effects[e.y]||(l.effects[e.y]={}),l.effects[e.y][e.x]||(l.effects[e.y][e.x]={});const t=++se(L,oe)._,s=c(this,te).clone();l.effects[e.y][e.x][t]=s,s.play().then(()=>{delete l.effects[e.y][e.x][t]})}};ee=new WeakMap,oe=new WeakMap,re=new WeakMap,te=new WeakMap,b(L,ee,{}),b(L,oe,0);let V=L;var ke=Object.defineProperty,xe=(r,e,t)=>e in r?ke(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t,u=(r,e,t)=>(xe(r,typeof e!="symbol"?e+"":e,t),t);class me{constructor(e){u(this,"_onPressed"),u(this,"_onPressedWithRepeat"),u(this,"_onReleased"),u(this,"_isPressed"),u(this,"_identity"),this._isPressed=!1,this._identity=e,typeof e=="function"?this._onPressedWithRepeat=e:(this._onPressed=e.onPressed,this._onPressedWithRepeat=e.onPressedWithRepeat,this._onReleased=e.onReleased)}get isEmpty(){return!this._onPressed&&!this._onPressedWithRepeat&&!this._onReleased}isOwnHandler(e){return this._identity===e}executePressed(e){var t,s;this._isPressed||(t=this._onPressed)==null||t.call(this,e),this._isPressed=!0,(s=this._onPressedWithRepeat)==null||s.call(this,e)}executeReleased(e){var t;this._isPressed&&((t=this._onReleased)==null||t.call(this,e)),this._isPressed=!1}}const ae=class A{constructor(e,t,s={}){u(this,"_normalizedKeyCombo"),u(this,"_parsedKeyCombo"),u(this,"_handlerState"),u(this,"_keyComboEventMapper"),u(this,"_movingToNextSequenceAt"),u(this,"_sequenceIndex"),u(this,"_unitIndex"),u(this,"_lastActiveKeyPresses"),u(this,"_lastActiveKeyCount"),u(this,"_isPressedWithFinalUnit"),this._normalizedKeyCombo=A.normalizeKeyCombo(e),this._parsedKeyCombo=A.parseKeyCombo(e),this._handlerState=new me(s),this._keyComboEventMapper=t,this._movingToNextSequenceAt=0,this._sequenceIndex=0,this._unitIndex=0,this._lastActiveKeyPresses=[],this._lastActiveKeyCount=0,this._isPressedWithFinalUnit=null}static parseKeyCombo(e){if(A._parseCache[e])return A._parseCache[e];const t=e.toLowerCase();let s="",i=[],n=[i],h=[n];const f=[h];let w=!1;for(let v=0;v<e.length;v+=1)if(t[v]==="\\")w=!0;else if((t[v]==="+"||t[v]===">"||t[v]===",")&&!w){if(s)throw new Error("cannot have two operators in a row");s=t[v]}else t[v].match(/[^\s]/)&&(s&&(s===","?(i=[],n=[i],h=[n],f.push(h)):s===">"?(i=[],n=[i],h.push(n)):s==="+"&&(i=[],n.push(i)),s=""),w=!1,i.push(t[v]));const k=f.map(v=>v.map(W=>W.map(_=>_.join(""))));return A._parseCache[e]=k,k}static stringifyKeyCombo(e){return e.map(t=>t.map(s=>s.map(i=>i==="+"?"\\+":i===">"?"\\>":i===","?"\\,":i).join("+")).join(">")).join(",")}static normalizeKeyCombo(e){if(A._normalizationCache[e])return A._normalizationCache[e];const t=this.stringifyKeyCombo(this.parseKeyCombo(e));return A._normalizationCache[e]=t,t}get isPressed(){return!!this._isPressedWithFinalUnit}get sequenceIndex(){return this.isPressed?this._parsedKeyCombo.length:this._sequenceIndex}isOwnHandler(e){return this._handlerState.isOwnHandler(e)}executePressed(e){var t;(t=this._isPressedWithFinalUnit)!=null&&t.has(e.key)&&this._handlerState.executePressed(this._wrapEvent(this._lastActiveKeyPresses,{key:e.key,event:e}))}executeReleased(e){var t;(t=this._isPressedWithFinalUnit)!=null&&t.has(e.key)&&(this._handlerState.executeReleased(this._wrapEvent(this._lastActiveKeyPresses,{key:e.key,event:e})),this._isPressedWithFinalUnit=null)}updateState(e,t){const s=e.length,i=s<this._lastActiveKeyCount;this._lastActiveKeyCount=s;const n=this._parsedKeyCombo[this._sequenceIndex],h=n.slice(0,this._unitIndex),f=n.slice(this._unitIndex),w=()=>{this._movingToNextSequenceAt=0,this._sequenceIndex=0,this._unitIndex=0,this._lastActiveKeyPresses.length=0,this._handlerState.isEmpty&&(this._isPressedWithFinalUnit=null)};let k=0;if(i){if(this._movingToNextSequenceAt===0)return w();if(this._movingToNextSequenceAt+t<Date.now()||s!==0)return;this._movingToNextSequenceAt=0,this._sequenceIndex+=1,this._unitIndex=0;return}for(const v of h){for(const W of v){let _=!1;for(let I=k;I<e.length&&I<k+v.length;I+=1)if(e[I].key===W){_=!0;break}if(!_)return w()}k+=v.length}if(this._movingToNextSequenceAt===0){for(const v of f){for(const W of v){let _=!1;for(let I=k;I<e.length&&I<k+v.length;I+=1)if(e[I].key===W){_=!0;break}if(!_)return}this._unitIndex+=1,k+=v.length}if(k<s-1)return w();if(this._lastActiveKeyPresses[this._sequenceIndex]=e.slice(0),this._sequenceIndex<this._parsedKeyCombo.length-1){this._movingToNextSequenceAt=Date.now();return}this._isPressedWithFinalUnit=new Set(n[n.length-1])}}_wrapEvent(e,t){return{...this._keyComboEventMapper(e,t),keyCombo:this._normalizedKeyCombo,keyEvents:e.flat().map(s=>s.event),finalKeyEvent:t.event}}};u(ae,"_parseCache",{}),u(ae,"_normalizationCache",{});let q=ae;const Se={addEventListener:(...r)=>{},removeEventListener:(...r)=>{},dispatchEvent:(...r)=>{}},Pe={userAgent:""},Z=()=>typeof document<"u"?document:Se,Ke=()=>typeof navigator<"u"?navigator:Pe,Ee=()=>Ke().userAgent.toLocaleLowerCase().includes("mac");let le=!1;const Ie=r=>{!Ee()||r.key!=="Meta"||(le=!0)},Ae=r=>{!le||r.key!=="Meta"||(le=!1,ye())},ie=new Map,Te=r=>{ie.set(r.key,r)},Re=r=>{ie.delete(r.key)},ye=()=>{for(const r of ie.values()){const e=new KeyboardEvent("keyup",{key:r.key,code:r.code,bubbles:!0,cancelable:!0});Z().dispatchEvent(e)}ie.clear()},Fe=r=>{try{const e=()=>r();return addEventListener("focus",e),()=>{removeEventListener("focus",e)}}catch{}},Le=r=>{try{const e=()=>{ye(),r()};return addEventListener("blur",e),()=>removeEventListener("blur",e)}catch{}},Me=r=>{try{const e=t=>(Te(t),Ie(t),r({key:t.key,originalEvent:t,composedPath:()=>t.composedPath(),preventDefault:()=>t.preventDefault()}));return Z().addEventListener("keydown",e),()=>Z().removeEventListener("keydown",e)}catch{}},qe=r=>{try{const e=t=>(Re(t),Ae(t),r({key:t.key,originalEvent:t,composedPath:()=>t.composedPath(),preventDefault:()=>t.preventDefault()}));return Z().addEventListener("keyup",e),()=>Z().removeEventListener("keyup",e)}catch{}},Oe=1e3;class Be{constructor(e={}){u(this,"sequenceTimeout"),u(this,"_isActive"),u(this,"_unbinder"),u(this,"_onActiveBinder"),u(this,"_onInactiveBinder"),u(this,"_onKeyPressedBinder"),u(this,"_onKeyReleasedBinder"),u(this,"_keyComboEventMapper"),u(this,"_selfReleasingKeys"),u(this,"_keyRemap"),u(this,"_handlerStates"),u(this,"_keyComboStates"),u(this,"_keyComboStatesArray"),u(this,"_activeKeyPresses"),u(this,"_activeKeyMap"),u(this,"_watchedKeyComboStates"),this.sequenceTimeout=Oe,this._isActive=!0,this._onActiveBinder=()=>{},this._onInactiveBinder=()=>{},this._onKeyPressedBinder=()=>{},this._onKeyReleasedBinder=()=>{},this._keyComboEventMapper=()=>({}),this._selfReleasingKeys=[],this._keyRemap={},this._handlerStates={},this._keyComboStates={},this._keyComboStatesArray=[],this._activeKeyPresses=[],this._activeKeyMap=new Map,this._watchedKeyComboStates={},this.bindEnvironment(e)}get pressedKeys(){return this._activeKeyPresses.map(e=>e.key)}bindKey(e,t){var s;e=e.toLowerCase();const i=new me(t);(s=this._handlerStates)[e]??(s[e]=[]),this._handlerStates[e].push(i)}unbindKey(e,t){e=e.toLowerCase();const s=this._handlerStates[e];if(s)if(t)for(let i=0;i<s.length;i+=1)s[i].isOwnHandler(t)&&(s.splice(i,1),i-=1);else s.length=0}bindKeyCombo(e,t){var s;e=q.normalizeKeyCombo(e);const i=new q(e,this._keyComboEventMapper,t);(s=this._keyComboStates)[e]??(s[e]=[]),this._keyComboStates[e].push(i),this._keyComboStatesArray.push(i)}unbindKeyCombo(e,t){e=q.normalizeKeyCombo(e);const s=this._keyComboStates[e];if(s)if(t){for(let i=0;i<s.length;i+=1)if(s[i].isOwnHandler(t)){for(let n=0;n<this._keyComboStatesArray.length;n+=1)this._keyComboStatesArray[n]===s[i]&&(this._keyComboStatesArray.splice(n,1),n-=1);s.splice(i,1),i-=1}}else s.length=0}checkKey(e){return this._activeKeyMap.has(e.toLowerCase())}checkKeyCombo(e){return this._ensureCachedKeyComboState(e).isPressed}checkKeyComboSequenceIndex(e){return this._ensureCachedKeyComboState(e).sequenceIndex}bindEnvironment(e={}){this.unbindEnvironment(),this._onActiveBinder=e.onActive??Fe,this._onInactiveBinder=e.onInactive??Le,this._onKeyPressedBinder=e.onKeyPressed??Me,this._onKeyReleasedBinder=e.onKeyReleased??qe,this._keyComboEventMapper=e.mapKeyComboEvent??(()=>({})),this._selfReleasingKeys=e.selfReleasingKeys??[],this._keyRemap=e.keyRemap??{};const t=this._onActiveBinder(()=>{this._isActive=!0}),s=this._onInactiveBinder(()=>{this._isActive=!1}),i=this._onKeyPressedBinder(h=>{this._handleKeyPress(h)}),n=this._onKeyReleasedBinder(h=>{this._handleKeyRelease(h)});this._unbinder=()=>{t==null||t(),s==null||s(),i==null||i(),n==null||n()}}unbindEnvironment(){var e;(e=this._unbinder)==null||e.call(this)}_ensureCachedKeyComboState(e){e=q.normalizeKeyCombo(e),this._watchedKeyComboStates[e]||(this._watchedKeyComboStates[e]=new q(e,this._keyComboEventMapper));const t=this._watchedKeyComboStates[e];return t.updateState(this._activeKeyPresses,this.sequenceTimeout),t}_handleKeyPress(e){if(!this._isActive)return;e={...e,key:e.key.toLowerCase()};const t=this._keyRemap[e.key];t&&(e.key=t);const s=this._handlerStates[e.key];if(s)for(const n of s)n.executePressed(e);const i=this._activeKeyMap.get(e.key);if(i)i.event=e;else{const n={key:e.key,event:e};this._activeKeyMap.set(e.key,n),this._activeKeyPresses.push(n)}this._updateKeyComboStates();for(const n of this._keyComboStatesArray)n.executePressed(e)}_handleKeyRelease(e){e={...e,key:e.key.toLowerCase()};const t=this._keyRemap[e.key];t&&(e.key=t);const s=this._handlerStates[e.key];if(s)for(const i of s)i.executeReleased(e);if(this._activeKeyMap.has(e.key)){this._activeKeyMap.delete(e.key);for(let i=0;i<this._activeKeyPresses.length;i+=1)if(this._activeKeyPresses[i].key===e.key){this._activeKeyPresses.splice(i,1),i-=1;break}}this._tryReleaseSelfReleasingKeys(),this._updateKeyComboStates();for(const i of this._keyComboStatesArray)i.executeReleased(e)}_updateKeyComboStates(){for(const e of this._keyComboStatesArray)e.updateState(this._activeKeyPresses,this.sequenceTimeout)}_tryReleaseSelfReleasingKeys(){for(const e of this._activeKeyPresses)for(const t of this._selfReleasingKeys)e.key===t&&this._handleKeyRelease(e.event)}}let je,ce;const De=r=>{ce=r??new Be(je)},pe=()=>(ce||De(),ce),We=(...r)=>pe().bindKey(...r),F=(...r)=>pe().checkKey(...r);q.normalizeKeyCombo;q.stringifyKeyCombo;q.parseKeyCombo;const o=class o{static init(){document.addEventListener("mousemove",o.onMove,!1),document.addEventListener("mousedown",e=>{(e.which===1||e.button===0)&&(o.buttons.left.isPressed=!0,o.onLeftButtonClick()),(e.which===3||e.button===2)&&(o.buttons.right.isPressed=!0,o.onRightButtonClick())}),document.addEventListener("mouseup",e=>{(e.which===1||e.button===0)&&(o.buttons.left.isPressed=!1,o.grabbing.itemId&&o.onGrabEnd()),(e.which===3||e.button===2)&&(o.buttons.right.isPressed=!1)}),document.addEventListener("contextmenu",e=>(e==null?void 0:e.cancelable)&&e.preventDefault())}static onMove(e){const t=l.ctx.canvas.getBoundingClientRect(),s={window:{...o.positionWindow},client:{...o.positionClient},server:{...o.positionServer}};o.positionWindow={x:e.clientX,y:e.clientY},o.positionClient={x:Math.floor(((e.clientX-t.left)/(t.right-t.left)*l.ctx.canvas.width+y.creature.offset.x)/d),y:Math.floor(((e.clientY-t.top)/(t.bottom-t.top)*l.ctx.canvas.height+y.creature.offset.y)/d)},o.positionServer=l.positionLocalToServer(o.positionClient),g.areEqual(o.positionClient,s.client)||o.onPositionChange(),g.areEqual(o.positionServer,s.server)||o.onPositionChange()}static onPositionChange(){if(o.grabbing.itemId)return;if(N.shift.isPressed){l.ctx.canvas.setAttribute("cursor","eye");return}o.positionServer=l.positionLocalToServer(o.positionClient);const e=l.getTileTopItem(o.positionServer);if(!e){l.ctx.canvas.removeAttribute("cursor");return}e===6?l.ctx.canvas.setAttribute("cursor","chest"):e===8?l.ctx.canvas.setAttribute("cursor","pick"):l.ctx.canvas.removeAttribute("cursor")}static onLeftButtonClick(){if(N.shift.isPressed)return;const e=l.getTileTopItem(o.positionServer);if(e&&K.get(e).isMoveable){o.onGrabStart(e);return}}static onRightButtonClick(){const e=l.getTileTopItem(o.positionServer);if(!o.buttons.right.isBlocked&&e&&l.isInHeroRange(o.positionServer)){if(e===6){o.buttons.right.isBlocked=!0,V.get("yellow-sparkles").run(o.positionServer),l.tiles[o.positionServer.y][o.positionServer.x].pop(),l.tiles[o.positionServer.y][o.positionServer.x].push(9),o.onPositionChange(),setTimeout(()=>{o.buttons.right.isBlocked=!1},600);return}if(e===8){o.buttons.right.isBlocked=!0,V.get("ore-hit").run(o.positionServer),l.tiles[y.creature.position.y][y.creature.position.x].push(10),setTimeout(()=>{o.buttons.right.isBlocked=!1},600);return}}}static onGrabStart(e){o.grabbing.itemId=e,o.grabbing.position={...o.positionServer},l.ctx.canvas.setAttribute("cursor","crosshair")}static onGrabEnd(){o.handleThrow(),o.grabbing.itemId=null,o.grabbing.position={x:null,y:null},o.onPositionChange()}static handleThrow(){if(l.isInHeroRange(o.grabbing.position)===!1||g.areEqual(o.grabbing.position,o.positionServer))return;const e=l.getTileTopItem(o.grabbing.position);e===o.grabbing.itemId&&(l.getTileStack(o.positionServer).find(t=>K.get(t).isBlockingCreatures)||(l.tiles[o.grabbing.position.y][o.grabbing.position.x].pop(),l.tiles[o.positionServer.y][o.positionServer.x].push(e)))}};m(o,"positionWindow",{x:null,y:null}),m(o,"positionClient",{x:null,y:null}),m(o,"positionServer",{x:null,y:null}),m(o,"buttons",{left:{isBlocked:!1,isPressed:!1},right:{isBlocked:!1,isPressed:!1}}),m(o,"grabbing",{itemId:null,position:{x:null,y:null}});let x=o;const M=class M{static init(){document.addEventListener("keydown",()=>setTimeout(M.triggerKeyHoldingFunctions)),window.keyboardLoop=setInterval(M.triggerKeyHoldingFunctions,200),We("shift",{onPressed:()=>{M.shift.isPressed=!0,x.onPositionChange()},onReleased:()=>{M.shift.isPressed=!1,x.onPositionChange()}})}};m(M,"shift",{isPressed:!1}),m(M,"triggerKeyHoldingFunctions",()=>{(F("ArrowUp")||F("w"))&&window.dispatchEvent(new CustomEvent("move-north")),(F("ArrowDown")||F("s"))&&window.dispatchEvent(new CustomEvent("move-south")),(F("ArrowLeft")||F("a"))&&window.dispatchEvent(new CustomEvent("move-west")),(F("ArrowRight")||F("d"))&&window.dispatchEvent(new CustomEvent("move-east"))});let N=M;class C{static renderTile(e,t,s,i,n,h){n==="ground"&&h.forEach(f=>{K.get(f).type==="ground"&&C.drawSprite(K.get(f).sprite.getFrame(),e,t)}),n==="objects"&&(N.shift.isPressed&&x.positionClient.x===e&&x.positionClient.y===t&&C.drawSprite(z.get("cursor").getFrame(),e,t),h.forEach(f=>{const w=K.get(f);w.type==="object"&&C.drawSprite(w.sprite.getFrame(),e,t)}),Object.values(l.creatures).forEach(f=>{s===f.position.x&&i===f.position.y&&C.drawCreature(f,e,t)}),l.getEffects(s,i).forEach(f=>{C.drawSprite(f.getFrame(),e,t)}))}static drawSprite(e,t,s){let i=s*d+(d-e.height),n=t*d+(Math.ceil(d/2)-Math.ceil(e.width/2));C.tempCtx.drawImage(e,n,i)}static drawCreature(e,t,s){let i=e.sprite.getFrame(),n=s*d+(d-i.height)+e.offset.y,h=t*d+(Math.ceil(d/2)-Math.ceil(i.width/2))+e.offset.x;C.tempCtx.drawImage(i,h,n)}static cropEdges(e){e.clearRect(0,0,d,e.canvas.height),e.clearRect(0,0,e.canvas.width,d),e.clearRect(e.canvas.width-d,0,e.canvas.width,e.canvas.height),e.clearRect(0,e.canvas.height-d,e.canvas.width,e.canvas.height)}static render(){const e=document.createElement("canvas");e.width=l.ctx.canvas.width,e.height=l.ctx.canvas.height,C.tempCtx=e.getContext("2d"),C.tempCtx.fillStyle="#25131a",C.tempCtx.fillRect(0,0,C.tempCtx.canvas.width,C.tempCtx.canvas.height);for(let t of["ground","objects"]){let s=0;for(let[i,n]of Object.entries(l.tiles)){let h=0;for(let[f,w]of Object.entries(n))C.renderTile(h,s,Number(f),Number(i),t,w),h++;s++}}C.renderInfoBox(C.tempCtx),l.ctx.clearRect(0,0,l.ctx.canvas.width,l.ctx.canvas.height),l.ctx.drawImage(e,-y.creature.offset.x,-y.creature.offset.y),C.cropEdges(l.ctx),window.requestAnimationFrame(C.render)}static renderInfoBox(e){if(N.shift.isPressed){const t={x:x.positionClient.x*d+d/3*2,y:x.positionClient.y*d+d/3*2};for(const[n,h]of Object.entries(l.creatures))if(x.positionServer.x===h.position.x&&x.positionServer.y===h.position.y){const f=n.length*5.5+8;e.fillStyle="#1c3d17",e.fillRect(t.x,t.y,f,16),e.strokeStyle="#FFA500",e.strokeRect(t.x,t.y,f,16),e.font="normal bold 9px monospace",e.strokeStyle="#000000",e.strokeText(n,t.x+4,t.y+11),e.strokeText(n,t.x+4,t.y+11),e.fillStyle="#FFA500",e.fillText(n,t.x+4,t.y+11);return}const s=l.getTileTopItem(x.positionServer),i=K.get(s);if(i&&i.type==="object"){const n=i.name.length*5.5+8;e.fillStyle="#172459",e.fillRect(t.x,t.y,n,16),e.strokeStyle="#FFA500",e.strokeRect(t.x,t.y,n,16),e.font="normal bold 9px monospace",e.strokeStyle="#000000",e.strokeText(i.name,t.x+4,t.y+11),e.strokeText(i.name,t.x+4,t.y+11),e.fillStyle="#FFA500",e.fillText(i.name,t.x+4,t.y+11)}}}}const _e=async()=>{async function r(){await z.load(we),await K.load(be),await V.load(Ce)}async function e(){N.init(),x.init(),y.init(),D.init(),l.init(),C.render()}await r(),await e()};_e();
